// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  ADMIN
  STYLIST
  RECEPTIONIST
  CLIENT
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  DIGITAL_WALLET
  OTHER
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

// Models
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  firstName     String
  lastName      String
  phone         String?
  role          UserRole
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  stylist       Stylist?
  client        Client?

  @@index([email])
  @@index([role])
}

model Client {
  id                String   @id @default(cuid())
  userId            String   @unique
  dateOfBirth       DateTime?
  preferredStylistId String?
  notes             String?  @db.Text
  allergies         String?  @db.Text
  preferredProducts String?  @db.Text
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  preferredStylist  Stylist?      @relation("PreferredClients", fields: [preferredStylistId], references: [id])
  appointments      Appointment[]
  invoices          Invoice[]

  @@index([userId])
  @@index([preferredStylistId])
}

model Stylist {
  id                String   @id @default(cuid())
  userId            String   @unique
  specialties       String?  @db.Text
  bio               String?  @db.Text
  hourlyRate        Float?
  commissionRate    Float?   @default(0.0)
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments      Appointment[]
  availability      StylistAvailability[]
  timeOff           StylistTimeOff[]
  stylistServices   StylistService[]
  preferredByClients Client[]           @relation("PreferredClients")

  @@index([userId])
  @@index([active])
}

model Service {
  id                String   @id @default(cuid())
  name              String
  description       String?  @db.Text
  category          String
  durationMinutes   Int
  basePrice         Float
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  appointmentServices AppointmentService[]
  stylistServices     StylistService[]
  invoiceItems        InvoiceItem[]

  @@index([category])
  @@index([active])
}

model StylistService {
  id        String   @id @default(cuid())
  stylistId String
  serviceId String
  createdAt DateTime @default(now())

  // Relations
  stylist   Stylist @relation(fields: [stylistId], references: [id], onDelete: Cascade)
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([stylistId, serviceId])
  @@index([stylistId])
  @@index([serviceId])
}

model Appointment {
  id              String            @id @default(cuid())
  clientId        String
  stylistId       String
  scheduledStart  DateTime
  scheduledEnd    DateTime
  actualStart     DateTime?
  actualEnd       DateTime?
  status          AppointmentStatus @default(SCHEDULED)
  notes           String?           @db.Text
  cancellationReason String?        @db.Text
  reminderSent    Boolean           @default(false)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  client          Client               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  stylist         Stylist              @relation(fields: [stylistId], references: [id])
  services        AppointmentService[]
  invoice         Invoice?

  @@index([clientId])
  @@index([stylistId])
  @@index([scheduledStart])
  @@index([status])
}

model AppointmentService {
  id            String   @id @default(cuid())
  appointmentId String
  serviceId     String
  price         Float
  createdAt     DateTime @default(now())

  // Relations
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  service       Service     @relation(fields: [serviceId], references: [id])

  @@index([appointmentId])
  @@index([serviceId])
}

model Invoice {
  id              String        @id @default(cuid())
  invoiceNumber   String        @unique
  appointmentId   String?       @unique
  clientId        String
  subtotal        Float
  tax             Float         @default(0.0)
  tip             Float         @default(0.0)
  discount        Float         @default(0.0)
  total           Float
  status          InvoiceStatus @default(DRAFT)
  dueDate         DateTime?
  paidAt          DateTime?
  notes           String?       @db.Text
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  appointment     Appointment?  @relation(fields: [appointmentId], references: [id])
  client          Client        @relation(fields: [clientId], references: [id])
  items           InvoiceItem[]
  payments        Payment[]

  @@index([clientId])
  @@index([appointmentId])
  @@index([status])
  @@index([invoiceNumber])
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  serviceId   String?
  description String
  quantity    Int      @default(1)
  unitPrice   Float
  total       Float
  createdAt   DateTime @default(now())

  // Relations
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  service     Service? @relation(fields: [serviceId], references: [id])

  @@index([invoiceId])
  @@index([serviceId])
}

model Payment {
  id              String        @id @default(cuid())
  invoiceId       String
  amount          Float
  method          PaymentMethod
  transactionId   String?
  notes           String?       @db.Text
  processedAt     DateTime      @default(now())
  createdAt       DateTime      @default(now())

  // Relations
  invoice         Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([processedAt])
}

model StylistAvailability {
  id          String    @id @default(cuid())
  stylistId   String
  dayOfWeek   DayOfWeek
  startTime   String    // Format: "HH:MM" (24-hour)
  endTime     String    // Format: "HH:MM" (24-hour)
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  stylist     Stylist   @relation(fields: [stylistId], references: [id], onDelete: Cascade)

  @@index([stylistId])
  @@index([dayOfWeek])
}

model StylistTimeOff {
  id          String   @id @default(cuid())
  stylistId   String
  startDate   DateTime
  endDate     DateTime
  reason      String?  @db.Text
  approved    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  stylist     Stylist  @relation(fields: [stylistId], references: [id], onDelete: Cascade)

  @@index([stylistId])
  @@index([startDate])
  @@index([endDate])
}
